WITH CTE AS(
SELECT
  L_ORG.MSTR_PROV_ID,
  L_IND.MSTR_PROV_ID,
  PN.SPCLTY_NM,
  NW.RGNL_NTWK_ID,
  PS_RS.TXNMY_CD,
  PS_RS.PROV_SPCLTY_EFCTV_DT,
  PS_RS.PROV_DATA_CRDNTLD_IND,
  PS_RS.PRMRY_SPCLTY_IND,
  H.TXNMY_SPCLZTN_NM,
  RS.PRMRY_SPCLTY_IND,
  RS.RLTD_PADRS_NW_SPCLTY_EFCTV_DT
FROM SPSOWNER.RLTD_PADRS_NTWK J
JOIN SPSOWNER.RLTD_PADRS K
  ON K.RLTD_PADRS_KEY = J.RLTD_PADRS_KEY
-- Organization provider (182)
JOIN SPSOWNER.PROV L_ORG
  ON L_ORG.MSTR_PROV_ID = K.MSTR_PROV_ID
AND L_ORG.PROV_CTGRY_CD = '182'
-- Individual provider (181)
JOIN SPSOWNER.PROV L_IND
  ON L_IND.MSTR_PROV_ID = K.RLTD_MSTR_PROV_ID
AND L_IND.PROV_CTGRY_CD = '181'
-- POA Network via J
JOIN SPSOWNER.POA_NTWK N
  ON N.POA_NTWK_KEY = J.POA_NTWK_KEY
-- Provider-Org-Network bridge
JOIN SPSOWNER.PROV_ORG_NTWK PON
  ON PON.PROV_ORG_NTWK_KEY = N.PROV_ORG_NTWK_KEY
-- Network (make it inner to filter early)
JOIN SPSOWNER.NTWK NW
  ON NW.NTWK_KEY = PON.NTWK_KEY
-- Network Specialty (optional, but left join is fine)
JOIN SPSOWNER.RLTD_PADRS_NTWK_SPCLTY RS
  ON RS.RLTD_PADRS_NTWK_KEY = J.RLTD_PADRS_NTWK_KEY
  
-- Resolve Specialty; constrain to primary to avoid explosion
JOIN SPSOWNER.PROV_SPCLTY PS_RS
  ON PS_RS.PROV_SPCLTY_KEY = RS.PROV_SPCLTY_KEY
JOIN BOT_PRCG_SPCLTY_XREF PN 
  ON PS_RS.SPCLTY_CD = PN.SPCLTY_CD

-- Taxonomy reference
JOIN SPSOWNER.HLTHCR_PROV_TXNMY_CD_RFRNC H
  ON H.TXNMY_CD = PS_RS.TXNMY_CD
--  AND H.TXNMY_SPCLZTN_NM = 'Infectious Disease'
WHERE L_ORG.NPI = '1376996827'
--L_ORG.MSTR_PROV_ID = '1100180573'
--AND L_IND.MSTR_PROV_ID = '1105639185'
AND L_IND.NPI = '1962776559'
AND PN.SPCLTY_NM = 'Social Work'
AND PS_RS.TXNMY_CD = '104100000X'
AND PS_RS.PRMRY_SPCLTY_IND = 'Y'
AND PS_RS.PROV_DATA_CRDNTLD_IND = 'Y'
--AND PS_RS.PROV_SPCLTY_EFCTV_DT = TO_DATE('1/1/1901', 'MM/DD/YYYY')
--AND NW.RGNL_NTWK_ID IN ('SMNTWKCLR001','SMNTWKCLR001','SMPFLHMOOPLA','SMPFLDSNPPLA','SMPFLCSNPPLA','SMPFLCAREPPO','SMPNTWKSNP01','SMPNTWKDSNP1','SMPNTWKHMO01','SMNTWKCAID01')
--AND RS.RLTD_PADRS_NW_SPCLTY_EFCTV_DT = TO_DATE('10/17/2025', 'MM/DD/YYYY')
)
SELECT 
CASE WHEN COUNT(*) > 0 THEN 'Audit Pass' ELSE 'Audit Fail' END AS Audit_result 
FROM CTE

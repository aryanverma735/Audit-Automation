WITH params AS (
  SELECT '801 E Williams Ave, Fallon, NV, 89406' AS full_addr FROM dual
),
addr_filter AS (
  SELECT 
    full_addr,
    REGEXP_REPLACE(UPPER(full_addr), '[^A-Z0-9]+', '') AS full_addr_norm
  FROM params
),
base AS (
  SELECT
    L_IND.MSTR_PROV_ID          AS IND_MSTR_PROV_ID,
    K.MSTR_PROV_ID              AS ORG_EID,
    M.PADRS_TYPE_CD             AS PADRS_TYPE_CD,

    /* Build ADDRESS_FULL once (same logic as your original) */
    (
      SELECT LISTAGG(val, ', ') WITHIN GROUP (ORDER BY pos)
      FROM (
        SELECT 1 AS pos, NULLIF(TRIM(S.ADRS_LINE_1_TXT), '') AS val FROM dual
        UNION ALL SELECT 2, NULLIF(TRIM(S.ADRS_LINE_2_TXT), '') FROM dual
        UNION ALL SELECT 3, NULLIF(TRIM(S.ADRS_LINE_3_TXT), '') FROM dual
        UNION ALL SELECT 4, NULLIF(TRIM(S.ADRS_CITY_NM),  '') FROM dual
        UNION ALL SELECT 5,
          CASE
            WHEN NVL(TRIM(S.POSTL_CD_ST_PRVNC_NM), '') IS NOT NULL
              OR NVL(TRIM(S.POSTL_CD), '') IS NOT NULL
            THEN TRIM(
                   NVL(TRIM(S.POSTL_CD_ST_PRVNC_NM), '') ||
                   CASE
                     WHEN NVL(TRIM(S.POSTL_CD_ST_PRVNC_NM), '') IS NOT NULL
                      AND NVL(TRIM(S.POSTL_CD), '') IS NOT NULL
                     THEN ' ' ELSE '' END ||
                   NVL(TRIM(S.POSTL_CD), '')
                 )
            ELSE NULL
          END
        FROM dual
      )
      WHERE val IS NOT NULL
    ) AS ADDRESS_FULL,

    NW.RGNL_NTWK_ID,
    NW.NTWK_TRMNTN_DT,
    NW.NTWK_TRMNTN_RSN_CD,
    J.RLTD_PADRS_NTWK_EFCTV_DT,
    J.RLTD_PADRS_NTWK_TRMNTN_DT,
    J.RLTD_PADRS_NTWK_TRMNTN_RSN_CD,

    PNC.CP_TYPE_CD AS ACPTG_PTNT_IND,
--    N.MAX_MBR_CNT,
    N.POA_NTWK_TRMNTN_RSN_CD,
    J.MAX_MBR_CNT,
    J.DIR_DSPLY_IND,
    J.MIN_AGE_NBR,
    J.MAX_AGE_NBR,
    J.PAT_GNDR_CD,
    J.DIR_SPRSN_RSN_CD,
    J.ROLE_CD,
    PS.SPCLTY_CD,
    RS.RLTD_PADRS_NW_SPCLTY_EFCTV_DT,
    RS.RLTD_PADRS_NW_SPCLTY_TRM_DT,
    RS.PRMRY_SPCLTY_IND,
    PN.SPCLTY_NM,
--    RM.RA_SOR_CD,
    RM.RA_1_ID,
    RM.RA_EFCTV_DT

  FROM SPSOWNER.RLTD_PADRS_NTWK J
  JOIN RLTD_PADRS_NTWK_RA RM 
    ON RM.RLTD_PADRS_NTWK_KEY = J.RLTD_PADRS_NTWK_KEY
  JOIN SPSOWNER.RLTD_PADRS K 
    ON K.RLTD_PADRS_KEY = J.RLTD_PADRS_KEY
  JOIN SPSOWNER.PROV L_ORG 
    ON L_ORG.MSTR_PROV_ID = K.MSTR_PROV_ID 
  JOIN SPSOWNER.PROV L_IND 
    ON L_IND.MSTR_PROV_ID = K.RLTD_MSTR_PROV_ID
  JOIN SPSOWNER.POA M 
    ON M.POA_KEY = K.POA_KEY 
  JOIN SPSOWNER.POA_NTWK N 
    ON N.POA_NTWK_KEY = J.POA_NTWK_KEY
  JOIN SPSOWNER.PROV_ORG_NTWK PON 
    ON PON.PROV_ORG_NTWK_KEY = N.PROV_ORG_NTWK_KEY
   AND PON.MSTR_PROV_ID = L_ORG.MSTR_PROV_ID
  JOIN SPSOWNER.NTWK NW 
    ON PON.NTWK_KEY = NW.NTWK_KEY
  JOIN SPSOWNER.STNDRDZD_ADRS S 
    ON M.SPS_STNDRDZD_ADRS_ID = S.SPS_STNDRDZD_ADRS_ID
  JOIN SPSOWNER.RLTD_PADRS_NTWK_CP PNC 
    ON PNC.RLTD_PADRS_NTWK_KEY = J.RLTD_PADRS_NTWK_KEY 
  JOIN SPSOWNER.RLTD_PADRS_NTWK_SPCLTY RS
    ON J.RLTD_PADRS_NTWK_KEY = RS.RLTD_PADRS_NTWK_KEY
  JOIN PROV_SPCLTY PS
    ON RS.PROV_SPCLTY_KEY = PS.PROV_SPCLTY_KEY
  JOIN BOT_PRCG_SPCLTY_XREF PN
    ON PS.SPCLTY_CD = PN.SPCLTY_CD
  
  WHERE 
    L_IND.MSTR_PROV_ID = '1101925164'
    AND L_ORG.MSTR_PROV_ID = '1101555770'
    AND NW.RGNL_NTWK_ID IN ('NVHMNN00')
--    'NVHPT200', 'NVHPX100', 'NVXPPO00')
    AND PNC.CP_TYPE_CD = '1936'
    AND J.MAX_MBR_CNT = '99999'                       
    AND J.RLTD_PADRS_NTWK_EFCTV_DT = TO_DATE('05/30/2024','MM/DD/YYYY')
    AND J.DIR_DSPLY_IND = 'Y'
    AND J.MIN_AGE_NBR = '0'
    AND J.MAX_AGE_NBR = '999'
    AND J.PAT_GNDR_CD = '8002'
    AND J.ROLE_CD = 'P'
--    AND RS.RLTD_PADRS_NW_SPCLTY_TRM_DT = TO_DATE('12/31/9999','MM/DD/YYYY')
    AND PN.SPCLTY_NM = 'Family Medicine' 
    AND RS.RLTD_PADRS_NW_SPCLTY_EFCTV_DT = TO_DATE('05/30/2024','MM/DD/YYYY')
    AND RS.PRMRY_SPCLTY_IND = 'Y'
-- REIMBURSEMENT FILTERS
    AND RM.RA_1_ID = ''
    
--    
)
SELECT 
    RGNL_NTWK_ID,
    CASE WHEN COUNT(*) > 0 THEN 'Audit Pass' ELSE 'Audit Fail' END AS "audit_result"
--  IND_MSTR_PROV_ID, ORG_EID, PADRS_TYPE_CD, ADDRESS_FULL, RGNL_NTWK_ID, RLTD_PADRS_NTWK_EFCTV_DT, NTWK_TRMNTN_RSN_CD, RLTD_PADRS_NTWK_TRMNTN_DT, RLTD_PADRS_NTWK_TRMNTN_RSN_CD,
--  ACPTG_PTNT_IND, MAX_MBR_CNT, POA_NTWK_TRMNTN_RSN_CD,
--  DIR_DSPLY_IND, MIN_AGE_NBR, MAX_AGE_NBR, PAT_GNDR_CD, DIR_SPRSN_RSN_CD, ROLE_CD, SPCLTY_CD,RLTD_PADRS_NW_SPCLTY_EFCTV_DT, 
--  RLTD_PADRS_NW_SPCLTY_TRM_DT, PRMRY_SPCLTY_IND, SPCLTY_NM
FROM base b
CROSS JOIN addr_filter p
WHERE REGEXP_REPLACE(UPPER(b.ADDRESS_FULL), '[^A-Z0-9]+', '') = p.full_addr_norm
GROUP BY RGNL_NTWK_ID
--GROUP BY RA_1_ID
